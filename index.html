<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-label {
            display: block;
            padding: 15px;
            background: #3498db;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-label:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .selected-file {
            margin-top: 10px;
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
        }

        .input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .code-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .code-input:focus {
            border-color: #3498db;
            outline: none;
        }

        .add-btn {
            padding: 12px 25px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .reset-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .toggle-btn {
            padding: 10px 15px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .toggle-btn:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }

        .category-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .category-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid;
        }

        .breakfast-box {
            border-left-color: #f39c12;
        }

        .lunch-box {
            border-left-color: #3498db;
        }

        .dinner-box {
            border-left-color: #9b59b6;
        }

        .fastfood-box {
            border-left-color: #e74c3c;
        }

        .category-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .food-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .food-item:hover {
            transform: translateY(-5px);
        }

        .food-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .food-code {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .food-details {
            font-size: 0.85rem;
            color: #555;
        }

        .nutrition-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px dotted #ecf0f1;
        }

        .nutrition-label {
            font-weight: 500;
        }

        .nutrition-value {
            font-weight: 600;
        }

        .summary-section {
            grid-column: 1 / -1;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-top: 5px solid;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .calories-card {
            border-top-color: #e74c3c;
        }

        .protein-card {
            border-top-color: #3498db;
        }

        .carbs-card {
            border-top-color: #2ecc71;
        }

        .fats-card {
            border-top-color: #f39c12;
        }

        .sodium-card {
            border-top-color: #9b59b6;
        }

        .fiber-card {
            border-top-color: #1abc9c;
        }

        .cholesterol-card {
            border-top-color: #e67e22;
        }

        .points-card {
            border-top-color: #8e44ad;
            grid-column: span 2;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9rem;
        }

        th {
            background: #34495e;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        tr:nth-child(even) {
            background-color: #fafafa;
        }

        .meal-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .breakfast { background: #ffeaa7; color: #e17055; }
        .lunch { background: #a29bfe; color: white; }
        .dinner { background: #fd79a8; color: white; }
        .fast-food { background: #74b9ff; color: white; }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .success {
            background: #2ecc71;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .hidden {
            display: none;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
            width: 100%;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: #c0392b;
        }

        .points-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .points-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #8e44ad;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 2.5rem;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .points-label {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .points-description {
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 20px;
        }

        .points-breakdown {
            width: 100%;
        }

        .points-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .points-nutrient {
            font-weight: 500;
            width: 100px;
        }

        .points-bar-container {
            flex: 1;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 0 15px;
            overflow: hidden;
        }

        .points-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .points-score {
            font-weight: bold;
            width: 40px;
            text-align: right;
        }

        .positive {
            background: #2ecc71;
        }

        .negative {
            background: #e74c3c;
        }

        .neutral {
            background: #3498db;
        }

        .daily-values-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .daily-values-table th {
            background: #2c3e50;
            padding: 12px 15px;
            text-align: left;
        }

        .daily-values-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .daily-values-table tr:last-child td {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .category-items {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 8px 5px;
            }
            
            .points-card {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçé Nutrition Tracker</h1>
            <div class="subtitle">Track your daily nutrition intake with ease</div>
        </header>

        <div class="main-content">
            <div class="left-column">
                <div class="card">
                    <h2 class="card-title">
                        Upload Your Data
                        <button id="resetCsvBtn" class="reset-btn">Reset CSV</button>
                    </h2>
                    <div class="upload-section">
                        <div class="file-input-wrapper">
                            <input type="file" id="csvFile" accept=".csv" class="file-input">
                            <label for="csvFile" class="file-label">üìÅ Choose CSV File</label>
                        </div>
                        <div id="selectedFileName" class="selected-file">No file selected</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Add Food Items</h2>
                    <div class="input-section">
                        <input type="text" id="foodCode" class="code-input" placeholder="Enter food code (e.g., B1, L20, D40, F60)">
                        <button id="addFoodBtn" class="add-btn">Add Food</button>
                    </div>
                    <button id="toggleTableBtn" class="toggle-btn">üìã Show/Hide Data Table</button>
                    <div id="tableContainer" class="table-container">
                        <table id="nutritionTable">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Item Name</th>
                                    <th>Portion Size</th>
                                    <th>Calories</th>
                                    <th>Protein (g)</th>
                                    <th>Protein (%DV)</th>
                                    <th>Sodium (mg)</th>
                                    <th>Sodium (%DV)</th>
                                    <th>Fats (g)</th>
                                    <th>Fats (%DV)</th>
                                    <th>Carbs (g)</th>
                                    <th>Carbs (%DV)</th>
                                    <th>Fiber (g)</th>
                                    <th>Fiber (%DV)</th>
                                    <th>Cholesterol (mg)</th>
                                    <th>Cholesterol (%DV)</th>
                                    <th>Meal Type</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="card">
                    <h2 class="card-title">
                        Your Food Items
                        <button id="resetCategoriesBtn" class="reset-btn">Reset Categories</button>
                    </h2>
                    <div class="category-section">
                        <div class="category-box breakfast-box">
                            <div class="category-title">
                                <span>üç≥ Breakfast</span>
                                <span id="breakfastCount">0 items</span>
                            </div>
                            <div id="breakfastItems" class="category-items"></div>
                        </div>

                        <div class="category-box lunch-box">
                            <div class="category-title">
                                <span>ü•™ Lunch</span>
                                <span id="lunchCount">0 items</span>
                            </div>
                            <div id="lunchItems" class="category-items"></div>
                        </div>

                        <div class="category-box dinner-box">
                            <div class="category-title">
                                <span>üçΩÔ∏è Dinner</span>
                                <span id="dinnerCount">0 items</span>
                            </div>
                            <div id="dinnerItems" class="category-items"></div>
                        </div>

                        <div class="category-box fastfood-box">
                            <div class="category-title">
                                <span>üçî Fast Food</span>
                                <span id="fastfoodCount">0 items</span>
                            </div>
                            <div id="fastfoodItems" class="category-items"></div>
                        </div>
                    </div>
                </div>

                <div class="card summary-section">
                    <h2 class="card-title">üìä Nutrition Summary</h2>
                    
                    <table class="daily-values-table">
                        <thead>
                            <tr>
                                <th>Nutrient</th>
                                <th>Daily Required Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Protein</td>
                                <td>50g</td>
                            </tr>
                            <tr>
                                <td>Sodium</td>
                                <td>2300mg</td>
                            </tr>
                            <tr>
                                <td>Fats</td>
                                <td>78g</td>
                            </tr>
                            <tr>
                                <td>Carbohydrates</td>
                                <td>275g</td>
                            </tr>
                            <tr>
                                <td>Fiber</td>
                                <td>28g</td>
                            </tr>
                            <tr>
                                <td>Cholesterol</td>
                                <td>300mg</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="summary-grid">
                        <div class="summary-card calories-card">
                            <div class="summary-label">Total Calories</div>
                            <div id="totalCalories" class="summary-value">0</div>
                            <div class="summary-label">kcal</div>
                        </div>
                        <div class="summary-card protein-card">
                            <div class="summary-label">Total Protein</div>
                            <div id="totalProtein" class="summary-value">0</div>
                            <div class="summary-label">grams</div>
                        </div>
                        <div class="summary-card carbs-card">
                            <div class="summary-label">Total Carbs</div>
                            <div id="totalCarbs" class="summary-value">0</div>
                            <div class="summary-label">grams</div>
                        </div>
                        <div class="summary-card fats-card">
                            <div class="summary-label">Total Fats</div>
                            <div id="totalFats" class="summary-value">0</div>
                            <div class="summary-label">grams</div>
                        </div>
                        <div class="summary-card sodium-card">
                            <div class="summary-label">Total Sodium</div>
                            <div id="totalSodium" class="summary-value">0</div>
                            <div class="summary-label">mg</div>
                        </div>
                        <div class="summary-card fiber-card">
                            <div class="summary-label">Total Fiber</div>
                            <div id="totalFiber" class="summary-value">0</div>
                            <div class="summary-label">grams</div>
                        </div>
                        <div class="summary-card cholesterol-card">
                            <div class="summary-label">Total Cholesterol</div>
                            <div id="totalCholesterol" class="summary-value">0</div>
                            <div class="summary-label">mg</div>
                        </div>
                        <div class="summary-card points-card">
                            <div class="points-display">
                                <div class="points-circle" id="pointsCircle">0</div>
                                <div class="points-label">Health Score</div>
                                <div class="points-description">Based on daily nutritional values</div>
                            </div>
                            <div class="points-breakdown">
                                <div class="points-item">
                                    <div class="points-nutrient">Protein</div>
                                    <div class="points-bar-container">
                                        <div id="proteinBar" class="points-bar positive" style="width: 0%"></div>
                                    </div>
                                    <div id="proteinScore" class="points-score">0</div>
                                </div>
                                <div class="points-item">
                                    <div class="points-nutrient">Carbs</div>
                                    <div class="points-bar-container">
                                        <div id="carbsBar" class="points-bar positive" style="width: 0%"></div>
                                    </div>
                                    <div id="carbsScore" class="points-score">0</div>
                                </div>
                                <div class="points-item">
                                    <div class="points-nutrient">Fats</div>
                                    <div class="points-bar-container">
                                        <div id="fatsBar" class="points-bar positive" style="width: 0%"></div>
                                    </div>
                                    <div id="fatsScore" class="points-score">0</div>
                                </div>
                                <div class="points-item">
                                    <div class="points-nutrient">Fiber</div>
                                    <div class="points-bar-container">
                                        <div id="fiberBar" class="points-bar positive" style="width: 0%"></div>
                                    </div>
                                    <div id="fiberScore" class="points-score">0</div>
                                </div>
                                <div class="points-item">
                                    <div class="points-nutrient">Sodium</div>
                                    <div class="points-bar-container">
                                        <div id="sodiumBar" class="points-bar negative" style="width: 0%"></div>
                                    </div>
                                    <div id="sodiumScore" class="points-score">0</div>
                                </div>
                                <div class="points-item">
                                    <div class="points-nutrient">Cholesterol</div>
                                    <div class="points-bar-container">
                                        <div id="cholesterolBar" class="points-bar negative" style="width: 0%"></div>
                                    </div>
                                    <div id="cholesterolScore" class="points-score">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="card loading hidden">
            üîÑ Loading and processing your nutrition data...
        </div>

        <div id="message" class="hidden"></div>
    </div>

    <script>
        // Global variables
        let nutritionData = [];
        let selectedFoods = [];
        let tableVisible = false;

        // Daily Values
        const dailyValues = {
            protein: 50,      // grams
            sodium: 2300,     // mg
            fats: 78,         // grams
            carbs: 275,       // grams
            fiber: 28,        // grams
            cholesterol: 300  // mg
        };

        // DOM elements
        const csvFileInput = document.getElementById('csvFile');
        const selectedFileName = document.getElementById('selectedFileName');
        const foodCodeInput = document.getElementById('foodCode');
        const addFoodBtn = document.getElementById('addFoodBtn');
        const toggleTableBtn = document.getElementById('toggleTableBtn');
        const tableContainer = document.getElementById('tableContainer');
        const tableBody = document.getElementById('tableBody');
        const loadingDiv = document.getElementById('loading');
        const messageDiv = document.getElementById('message');
        const resetCsvBtn = document.getElementById('resetCsvBtn');
        const resetCategoriesBtn = document.getElementById('resetCategoriesBtn');

        // Category elements
        const breakfastItems = document.getElementById('breakfastItems');
        const lunchItems = document.getElementById('lunchItems');
        const dinnerItems = document.getElementById('dinnerItems');
        const fastfoodItems = document.getElementById('fastfoodItems');
        
        // Count elements
        const breakfastCount = document.getElementById('breakfastCount');
        const lunchCount = document.getElementById('lunchCount');
        const dinnerCount = document.getElementById('dinnerCount');
        const fastfoodCount = document.getElementById('fastfoodCount');
        
        // Summary elements
        const totalCalories = document.getElementById('totalCalories');
        const totalProtein = document.getElementById('totalProtein');
        const totalCarbs = document.getElementById('totalCarbs');
        const totalFats = document.getElementById('totalFats');
        const totalSodium = document.getElementById('totalSodium');
        const totalFiber = document.getElementById('totalFiber');
        const totalCholesterol = document.getElementById('totalCholesterol');
        
        // Points elements
        const pointsCircle = document.getElementById('pointsCircle');
        
        // Points bars
        const proteinBar = document.getElementById('proteinBar');
        const carbsBar = document.getElementById('carbsBar');
        const fatsBar = document.getElementById('fatsBar');
        const fiberBar = document.getElementById('fiberBar');
        const sodiumBar = document.getElementById('sodiumBar');
        const cholesterolBar = document.getElementById('cholesterolBar');
        
        // Points scores
        const proteinScore = document.getElementById('proteinScore');
        const carbsScore = document.getElementById('carbsScore');
        const fatsScore = document.getElementById('fatsScore');
        const fiberScore = document.getElementById('fiberScore');
        const sodiumScore = document.getElementById('sodiumScore');
        const cholesterolScore = document.getElementById('cholesterolScore');

        // Event listeners
        csvFileInput.addEventListener('change', handleFileUpload);
        addFoodBtn.addEventListener('click', addFoodByCode);
        foodCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addFoodByCode();
        });
        toggleTableBtn.addEventListener('click', toggleTable);
        resetCsvBtn.addEventListener('click', resetCsv);
        resetCategoriesBtn.addEventListener('click', resetCategories);

        // Load data from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedFileName.textContent = `Selected: ${file.name}`;
            loadingDiv.classList.remove('hidden');
            messageDiv.classList.add('hidden');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    loadingDiv.classList.add('hidden');
                    
                    if (results.errors.length > 0) {
                        showMessage('Error parsing CSV: ' + results.errors[0].message, 'error');
                        return;
                    }
                    
                    if (results.data.length === 0) {
                        showMessage('No data found in CSV file.', 'error');
                        return;
                    }
                    
                    nutritionData = results.data;
                    console.log('Loaded nutrition data:', nutritionData); // Debug log
                    updateTable();
                    saveToLocalStorage();
                    showMessage('CSV data loaded successfully! You can now add food items by code.', 'success');
                },
                error: function(error) {
                    loadingDiv.classList.add('hidden');
                    showMessage('Error reading file: ' + error.message, 'error');
                }
            });
        }

        function addFoodByCode() {
            const code = foodCodeInput.value.trim().toUpperCase();
            
            if (!code) {
                showMessage('Please enter a food code.', 'error');
                return;
            }
            
            if (nutritionData.length === 0) {
                showMessage('Please upload a CSV file first.', 'error');
                return;
            }
            
            console.log('Looking for code:', code); // Debug log
            console.log('Available codes:', nutritionData.map(item => item.code)); // Debug log
            
            const foodItem = nutritionData.find(item => {
                // Handle both string and number codes
                const itemCode = String(item.code || '').toUpperCase();
                return itemCode === code;
            });
            
            if (!foodItem) {
                showMessage(`Food with code "${code}" not found. Available codes: ${nutritionData.map(item => item.code).join(', ')}`, 'error');
                return;
            }
            
            // Check if already added
            if (selectedFoods.some(item => item.code === foodItem.code)) {
                showMessage(`Food with code "${code}" is already added.`, 'error');
                return;
            }
            
            selectedFoods.push(foodItem);
            updateCategories();
            updateSummary();
            saveToLocalStorage();
            foodCodeInput.value = '';
            showMessage(`Added: ${foodItem['Item Name']}`, 'success');
        }

        function removeFood(code) {
            selectedFoods = selectedFoods.filter(item => item.code !== code);
            updateCategories();
            updateSummary();
            saveToLocalStorage();
            showMessage(`Removed food item.`, 'success');
        }

        function updateCategories() {
            // Clear all categories
            breakfastItems.innerHTML = '';
            lunchItems.innerHTML = '';
            dinnerItems.innerHTML = '';
            fastfoodItems.innerHTML = '';
            
            // Count items per category
            let breakfastCountValue = 0;
            let lunchCountValue = 0;
            let dinnerCountValue = 0;
            let fastfoodCountValue = 0;
            
            // Add items to their respective categories
            selectedFoods.forEach(item => {
                const mealType = String(item['meal type'] || '').toLowerCase();
                const foodElement = createFoodElement(item);
                
                console.log('Processing item:', item['Item Name'], 'with meal type:', mealType); // Debug log
                
                if (mealType.includes('breakfast')) {
                    breakfastItems.appendChild(foodElement);
                    breakfastCountValue++;
                    console.log('Added to breakfast'); // Debug log
                } else if (mealType.includes('lunch')) {
                    lunchItems.appendChild(foodElement);
                    lunchCountValue++;
                    console.log('Added to lunch'); // Debug log
                } else if (mealType.includes('dinner')) {
                    dinnerItems.appendChild(foodElement);
                    dinnerCountValue++;
                    console.log('Added to dinner'); // Debug log
                } else if (mealType.includes('fast')) {
                    fastfoodItems.appendChild(foodElement);
                    fastfoodCountValue++;
                    console.log('Added to fast food'); // Debug log
                } else {
                    console.log('No matching category for:', mealType); // Debug log
                }
            });
            
            // Update counts
            breakfastCount.textContent = `${breakfastCountValue} item${breakfastCountValue !== 1 ? 's' : ''}`;
            lunchCount.textContent = `${lunchCountValue} item${lunchCountValue !== 1 ? 's' : ''}`;
            dinnerCount.textContent = `${dinnerCountValue} item${dinnerCountValue !== 1 ? 's' : ''}`;
            fastfoodCount.textContent = `${fastfoodCountValue} item${fastfoodCountValue !== 1 ? 's' : ''}`;
        }

        function createFoodElement(item) {
            const foodDiv = document.createElement('div');
            foodDiv.className = 'food-item';
            
            foodDiv.innerHTML = `
                <div class="food-name">${item['Item Name']}</div>
                <div class="food-code">Code: ${item.code}</div>
                <div class="food-details">
                    <div class="nutrition-row">
                        <span class="nutrition-label">Portion Size:</span>
                        <span class="nutrition-value">${item['Portion Size'] || 'N/A'}</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Calories:</span>
                        <span class="nutrition-value">${item.Calories || 0}</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Protein:</span>
                        <span class="nutrition-value">${item['Protein (g)'] || 0}g (${item['Protein (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Sodium:</span>
                        <span class="nutrition-value">${item['Sodium (mg)'] || 0}mg (${item['Sodium (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Fats:</span>
                        <span class="nutrition-value">${item['Fats (g)'] || 0}g (${item['Fats (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Carbs:</span>
                        <span class="nutrition-value">${item['Carbohydrates (g)'] || 0}g (${item['Carbohydrates (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Fiber:</span>
                        <span class="nutrition-value">${item['Fiber (g)'] || 0}g (${item['Fiber (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Cholesterol:</span>
                        <span class="nutrition-value">${item['Cholesterol (mg)'] || 0}mg (${item['Cholesterol (%DV)'] || 0})</span>
                    </div>
                </div>
                <button class="remove-btn" onclick="removeFood('${item.code}')">Remove</button>
            `;
            
            return foodDiv;
        }

        function updateSummary() {
            let calories = 0;
            let protein = 0;
            let carbs = 0;
            let fats = 0;
            let sodium = 0;
            let fiber = 0;
            let cholesterol = 0;
            
            selectedFoods.forEach(item => {
                calories += item.Calories || 0;
                protein += item['Protein (g)'] || 0;
                carbs += item['Carbohydrates (g)'] || 0;
                fats += item['Fats (g)'] || 0;
                sodium += item['Sodium (mg)'] || 0;
                fiber += item['Fiber (g)'] || 0;
                cholesterol += item['Cholesterol (mg)'] || 0;
            });
            
            // Update values
            totalCalories.textContent = calories;
            totalProtein.textContent = protein.toFixed(1);
            totalCarbs.textContent = carbs.toFixed(1);
            totalFats.textContent = fats.toFixed(1);
            totalSodium.textContent = sodium;
            totalFiber.textContent = fiber.toFixed(1);
            totalCholesterol.textContent = cholesterol;
            
            // Calculate points and update bars
            updatePointsDisplay(protein, carbs, fats, sodium, fiber, cholesterol);
        }

        function updatePointsDisplay(protein, carbs, fats, sodium, fiber, cholesterol) {
            // Calculate individual scores
            const proteinScoreValue = calculateProteinScore(protein);
            const carbsScoreValue = calculateCarbsScore(carbs);
            const fatsScoreValue = calculateFatsScore(fats);
            const sodiumScoreValue = calculateSodiumScore(sodium);
            const fiberScoreValue = calculateFiberScore(fiber);
            const cholesterolScoreValue = calculateCholesterolScore(cholesterol);
            
            // Calculate total score
            const totalScore = Math.max(0, Math.min(100, 
                50 + proteinScoreValue + carbsScoreValue + fatsScoreValue + 
                sodiumScoreValue + fiberScoreValue + cholesterolScoreValue
            ));
            
            // Update points circle
            pointsCircle.textContent = Math.round(totalScore);
            
            // Update colors based on score
            if (totalScore >= 80) {
                pointsCircle.style.background = '#2ecc71'; // Green
            } else if (totalScore >= 60) {
                pointsCircle.style.background = '#f39c12'; // Orange
            } else {
                pointsCircle.style.background = '#e74c3c'; // Red
            }
            
            // Update bars and scores
            updateBar(proteinBar, proteinScore, proteinScoreValue, 10);
            updateBar(carbsBar, carbsScore, carbsScoreValue, 10);
            updateBar(fatsBar, fatsScore, fatsScoreValue, 10);
            updateBar(fiberBar, fiberScore, fiberScoreValue, 15);
            updateBar(sodiumBar, sodiumScore, sodiumScoreValue, -15);
            updateBar(cholesterolBar, cholesterolScore, cholesterolScoreValue, -15);
        }

        function updateBar(barElement, scoreElement, scoreValue, maxScore) {
            // Calculate percentage for bar width
            const percentage = Math.min(100, Math.abs(scoreValue) / Math.abs(maxScore) * 100);
            barElement.style.width = `${percentage}%`;
            
            // Update score text
            scoreElement.textContent = scoreValue > 0 ? `+${scoreValue}` : scoreValue;
            
            // Update bar color based on score
            if (scoreValue > 0) {
                barElement.className = 'points-bar positive';
            } else if (scoreValue < 0) {
                barElement.className = 'points-bar negative';
            } else {
                barElement.className = 'points-bar neutral';
            }
        }

        function calculateProteinScore(protein) {
            const percent = (protein / dailyValues.protein) * 100;
            if (percent <= 100) {
                return Math.round((percent / 100) * 10); // Up to +10 points
            } else {
                return 10 - Math.round(((percent - 100) / 100) * 5); // Slight penalty for excess
            }
        }

        function calculateCarbsScore(carbs) {
            const percent = (carbs / dailyValues.carbs) * 100;
            if (percent <= 100) {
                return Math.round((percent / 100) * 10); // Up to +10 points
            } else {
                return 10 - Math.round(((percent - 100) / 100) * 15); // Penalty for excess
            }
        }

        function calculateFatsScore(fats) {
            const percent = (fats / dailyValues.fats) * 100;
            if (percent <= 100) {
                return Math.round((percent / 100) * 10); // Up to +10 points
            } else {
                return 10 - Math.round(((percent - 100) / 100) * 15); // Penalty for excess
            }
        }

        function calculateSodiumScore(sodium) {
            const percent = (sodium / dailyValues.sodium) * 100;
            if (percent <= 100) {
                return 0; // No points for being under sodium limit
            } else {
                return -Math.round(((percent - 100) / 100) * 15); // Penalty for excess
            }
        }

        function calculateFiberScore(fiber) {
            const percent = (fiber / dailyValues.fiber) * 100;
            if (percent <= 100) {
                return Math.round((percent / 100) * 10); // Up to +10 points
            } else {
                return 10 + Math.round(((percent - 100) / 100) * 5); // Bonus for extra fiber
            }
        }

        function calculateCholesterolScore(cholesterol) {
            const percent = (cholesterol / dailyValues.cholesterol) * 100;
            if (percent <= 100) {
                return 0; // No points for being under cholesterol limit
            } else {
                return -Math.round(((percent - 100) / 100) * 15); // Penalty for excess
            }
        }

        function updateTable() {
            tableBody.innerHTML = '';
            
            nutritionData.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.code || 'N/A'}</td>
                    <td>${item['Item Name'] || 'N/A'}</td>
                    <td>${item['Portion Size'] || 'N/A'}</td>
                    <td>${item.Calories || 'N/A'}</td>
                    <td>${item['Protein (g)'] || 'N/A'}</td>
                    <td>${item['Protein (%DV)'] || 'N/A'}</td>
                    <td>${item['Sodium (mg)'] || 'N/A'}</td>
                    <td>${item['Sodium (%DV)'] || 'N/A'}</td>
                    <td>${item['Fats (g)'] || 'N/A'}</td>
                    <td>${item['Fats (%DV)'] || 'N/A'}</td>
                    <td>${item['Carbohydrates (g)'] || 'N/A'}</td>
                    <td>${item['Carbohydrates (%DV)'] || 'N/A'}</td>
                    <td>${item['Fiber (g)'] || 'N/A'}</td>
                    <td>${item['Fiber (%DV)'] || 'N/A'}</td>
                    <td>${item['Cholesterol (mg)'] || 'N/A'}</td>
                    <td>${item['Cholesterol (%DV)'] || 'N/A'}</td>
                    <td><span class="meal-type ${getMealTypeClass(item['meal type'])}">${item['meal type'] || 'N/A'}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function getMealTypeClass(mealType) {
            if (!mealType) return '';
            const type = String(mealType).toLowerCase();
            if (type.includes('breakfast')) return 'breakfast';
            if (type.includes('lunch')) return 'lunch';
            if (type.includes('dinner')) return 'dinner';
            if (type.includes('fast')) return 'fast-food';
            return '';
        }

        function toggleTable() {
            tableVisible = !tableVisible;
            tableContainer.style.display = tableVisible ? 'block' : 'none';
            toggleTableBtn.textContent = tableVisible ? 'üìã Hide Data Table' : 'üìã Show Data Table';
        }

        function resetCsv() {
            nutritionData = [];
            selectedFoods = [];
            csvFileInput.value = '';
            selectedFileName.textContent = 'No file selected';
            tableBody.innerHTML = '';
            updateCategories();
            updateSummary();
            saveToLocalStorage();
            showMessage('CSV data has been reset.', 'success');
        }

        function resetCategories() {
            selectedFoods = [];
            updateCategories();
            updateSummary();
            saveToLocalStorage();
            showMessage('All food items have been removed from categories.', 'success');
        }

        function saveToLocalStorage() {
            localStorage.setItem('nutritionData', JSON.stringify(nutritionData));
            localStorage.setItem('selectedFoods', JSON.stringify(selectedFoods));
            localStorage.setItem('csvFileName', selectedFileName.textContent);
        }

        function loadFromLocalStorage() {
            const savedNutritionData = localStorage.getItem('nutritionData');
            const savedSelectedFoods = localStorage.getItem('selectedFoods');
            const savedCsvFileName = localStorage.getItem('csvFileName');
            
            if (savedNutritionData) {
                nutritionData = JSON.parse(savedNutritionData);
                updateTable();
            }
            
            if (savedSelectedFoods) {
                selectedFoods = JSON.parse(savedSelectedFoods);
                updateCategories();
                updateSummary();
            }
            
            if (savedCsvFileName && savedCsvFileName !== 'No file selected') {
                selectedFileName.textContent = savedCsvFileName;
            }
            
            if (savedNutritionData || savedSelectedFoods) {
                showMessage('Previous data loaded successfully.', 'success');
            }
        }

        function showMessage(message, type) {
            messageDiv.textContent = message;
            messageDiv.className = type;
            messageDiv.classList.remove('hidden');
            
            // Auto-hide message after 3 seconds
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
